name: Build and Deploy Blog

on:
    push:
        branches:
            - master
    issues:
        types: [edited, labeled, unlabeled]
    workflow_dispatch:
        inputs:
            full_rebuild:
                description: '执行全量构建'
                required: false
                type: boolean
                default: false
    schedule:
        # 每周日凌晨 2 点执行全量构建
        - cron: '0 2 * * 0'

jobs:
    build-deploy:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            pages: write
            id-token: write
            issues: read

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Check if build is needed
              id: check_build
              if: github.event_name == 'issues'
              uses: actions/github-script@v7
              with:
                  script: |
                      const issueNumber = context.payload.issue?.number;
                      if (!issueNumber) {
                        core.setOutput('should_build', 'true');
                        return;
                      }

                      const issue = await github.rest.issues.get({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: issueNumber
                      });

                      const labels = issue.data.labels.map(l => l.name);
                      const hasPublishedLabel = labels.some(l => l === '状态:已发布');
                      const hadPublishedLabel = context.payload.changes?.labels?.from?.some(l => l.name === '状态:已发布');

                      // 只有当前是已发布，或者之前是已发布（需要删除）时才构建
                      const shouldBuild = hasPublishedLabel || hadPublishedLabel;
                      core.setOutput('should_build', shouldBuild ? 'true' : 'false');
                      console.log(`Issue #${issueNumber} 构建检查: ${shouldBuild ? '需要构建' : '跳过构建（非已发布状态）'}`);

            - name: Restore articles cache
              if: (github.event_name != 'schedule' && github.event.inputs.full_rebuild != 'true') && (github.event_name != 'issues' || steps.check_build.outputs.should_build == 'true')
              uses: actions/cache@v4
              with:
                  path: public/data
                  key: articles-${{ github.run_id }}
                  restore-keys: |
                      articles-

            - name: Build articles data
              if: github.event_name != 'issues' || steps.check_build.outputs.should_build == 'true'
              uses: actions/github-script@v7
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  script: |
                      const fs = require('fs');
                      const path = require('path');

                      // 确保数据目录存在
                      const dataDir = path.join(process.cwd(), 'public', 'data');
                      if (!fs.existsSync(dataDir)) {
                        fs.mkdirSync(dataDir, { recursive: true });
                      }

                      const articlesFile = path.join(dataDir, 'articles.json');

                      // 判断是否为全量构建
                      const isFullRebuild = context.eventName === 'schedule' || 
                                            context.payload.inputs?.full_rebuild === 'true' ||
                                            !fs.existsSync(articlesFile);

                      // 辅助函数：解析标签
                      function parseLabels(labels) {
                        const labelNames = labels.map(l => l.name);
                        return {
                          status: labelNames.find(l => l.startsWith('状态:'))?.replace('状态:', ''),
                          categories: labelNames.filter(l => l.startsWith('分类:')).map(l => l.replace('分类:', '')),
                          features: labelNames.filter(l => l.startsWith('功能:')).map(l => l.replace('功能:', '')),
                          tags: labelNames.filter(l => !l.includes(':'))
                        };
                      }

                      // 辅助函数：提取封面图
                      function extractCoverImage(body) {
                        const imageRegex = /!\[.*?\]\((https?:\/\/[^\)]+)\)/;
                        const match = body?.match(imageRegex);
                        return match ? match[1] : 'https://images.unsplash.com/photo-1461749280684-dccba630e2f6?w=1200&auto=format&fit=crop';
                      }

                      // 辅助函数：提取摘要
                      function extractDescription(body) {
                        if (!body) return '';
                        const text = body.replace(/[#*`\[\]]/g, '').trim();
                        return text.substring(0, 200) + (text.length > 200 ? '...' : '');
                      }

                      // 辅助函数：计算阅读时间
                      function calculateReadTime(body) {
                        if (!body) return '1 分钟';
                        const words = body.length;
                        const minutes = Math.ceil(words / 300);
                        return `${minutes} 分钟阅读`;
                      }

                      // 辅助函数：解析单个 Issue
                      async function parseIssue(issue) {
                        const parsed = parseLabels(issue.labels);
                        
                        // 获取评论数
                        const comments = await github.rest.issues.listComments({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: issue.number
                        });
                        
                        return {
                          id: issue.id,
                          number: issue.number,
                          title: issue.title,
                          description: extractDescription(issue.body),
                          content: issue.body || '',
                          author: {
                            name: issue.user.login,
                            avatar: issue.user.avatar_url,
                            url: issue.user.html_url
                          },
                          status: parsed.status || '草稿',
                          categories: parsed.categories,
                          tags: parsed.tags,
                          features: parsed.features,
                          coverImage: extractCoverImage(issue.body),
                          readTime: calculateReadTime(issue.body),
                          createdAt: issue.created_at,
                          updatedAt: issue.updated_at,
                          commentsCount: comments.data.length,
                          url: issue.html_url
                        };
                      }

                      let articlesData = { articles: [], total: 0, lastUpdate: new Date().toISOString() };
                      let shouldUpdateStats = isFullRebuild; // 标记是否需要更新标签和分类统计

                      if (isFullRebuild) {
                        console.log('执行全量构建...');
                        
                        // 获取所有已发布的 Issues
                        const issues = await github.paginate(github.rest.issues.listForRepo, {
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          state: 'open',
                          labels: '状态:已发布',
                          per_page: 100
                        });
                        
                        console.log(`找到 ${issues.length} 篇已发布文章`);
                        
                        // 解析所有文章
                        for (const issue of issues) {
                          const article = await parseIssue(issue);
                          articlesData.articles.push(article);
                        }
                        
                      } else {
                        console.log('执行增量构建...');
                        
                        // 读取现有数据
                        if (fs.existsSync(articlesFile)) {
                          articlesData = JSON.parse(fs.readFileSync(articlesFile, 'utf8'));
                        }
                        
                        // 检测是否是标签变更（labeled/unlabeled 事件）
                        const isLabelChange = context.eventName === 'issues' && 
                          (context.payload.action === 'labeled' || context.payload.action === 'unlabeled');
                        
                        // 获取触发事件的 Issue
                        const issueNumber = context.payload.issue?.number;
                        if (issueNumber) {
                          const issue = await github.rest.issues.get({
                            owner: context.repo.owner,
                            repo: context.repo.repo,
                            issue_number: issueNumber
                          });
                          
                          const parsed = parseLabels(issue.data.labels);
                          const isPublished = parsed.status === '已发布';
                          
                          // 查找现有文章
                          const existingIndex = articlesData.articles.findIndex(a => a.number === issueNumber);
                          
                          if (isPublished) {
                            // 更新或新增文章
                            const article = await parseIssue(issue.data);
                            
                            if (existingIndex >= 0) {
                              articlesData.articles[existingIndex] = article;
                              console.log(`更新文章 #${issueNumber}: ${article.title}`);
                            } else {
                              articlesData.articles.push(article);
                              console.log(`新增文章 #${issueNumber}: ${article.title}`);
                              shouldUpdateStats = true; // 新增文章需要更新统计
                            }
                            
                            // 如果是标签变更，需要更新统计
                            if (isLabelChange) {
                              shouldUpdateStats = true;
                              console.log('检测到标签变更，将更新标签和分类统计');
                            }
                          } else {
                            // 删除文章
                            if (existingIndex >= 0) {
                              articlesData.articles.splice(existingIndex, 1);
                              console.log(`删除文章 #${issueNumber}`);
                              shouldUpdateStats = true; // 删除文章需要更新统计
                            }
                          }
                        }
                      }

                      // 按置顶和时间排序
                      articlesData.articles.sort((a, b) => {
                        const aPinned = a.features.includes('置顶');
                        const bPinned = b.features.includes('置顶');
                        if (aPinned !== bPinned) return bPinned ? 1 : -1;
                        return new Date(b.updatedAt) - new Date(a.updatedAt);
                      });

                      articlesData.total = articlesData.articles.length;
                      articlesData.lastUpdate = new Date().toISOString();

                      // 保存文章数据
                      fs.writeFileSync(articlesFile, JSON.stringify(articlesData, null, 2));
                      console.log(`已保存 ${articlesData.total} 篇文章到 articles.json`);

                      // 只在需要时更新分类和标签统计
                      if (shouldUpdateStats) {
                        console.log('更新标签和分类统计...');
                        
                        // 生成分类统计
                        const categoriesMap = {};
                        articlesData.articles.forEach(article => {
                          article.categories.forEach(cat => {
                            if (!categoriesMap[cat]) {
                              categoriesMap[cat] = { name: cat, slug: cat, count: 0, color: 'text-primary' };
                            }
                            categoriesMap[cat].count++;
                          });
                        });

                        const categoriesData = {
                          categories: Object.values(categoriesMap)
                        };
                        fs.writeFileSync(path.join(dataDir, 'categories.json'), JSON.stringify(categoriesData, null, 2));
                        console.log(`已生成分类统计: ${categoriesData.categories.length} 个分类`);

                        // 生成标签统计
                        const tagsMap = {};
                        articlesData.articles.forEach(article => {
                          article.tags.forEach(tag => {
                            tagsMap[tag] = (tagsMap[tag] || 0) + 1;
                          });
                        });

                        const tagsData = {
                          tags: Object.entries(tagsMap).map(([name, count]) => ({ name, count }))
                            .sort((a, b) => b.count - a.count)
                        };
                        fs.writeFileSync(path.join(dataDir, 'tags.json'), JSON.stringify(tagsData, null, 2));
                        console.log(`已生成标签统计: ${tagsData.tags.length} 个标签`);
                      } else {
                        console.log('跳过标签和分类统计更新（仅文章内容变更）');
                      }

            - name: Build project
              if: github.event_name != 'issues' || steps.check_build.outputs.should_build == 'true'
              run: npm run build

            - name: Add .nojekyll file
              if: github.event_name != 'issues' || steps.check_build.outputs.should_build == 'true'
              run: touch ./dist/.nojekyll

            - name: Setup Pages
              if: github.event_name != 'issues' || steps.check_build.outputs.should_build == 'true'
              uses: actions/configure-pages@v5

            - name: Upload artifact
              if: github.event_name != 'issues' || steps.check_build.outputs.should_build == 'true'
              uses: actions/upload-pages-artifact@v3
              with:
                  path: ./dist

            - name: Deploy to GitHub Pages
              if: github.event_name != 'issues' || steps.check_build.outputs.should_build == 'true'
              id: deployment
              uses: actions/deploy-pages@v4
