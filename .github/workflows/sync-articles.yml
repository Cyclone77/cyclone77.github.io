name: Sync Articles

on:
    issues:
        types: [edited, unlabeled] # opened 和 labeled 交给 Guard 任务处理后触发
    workflow_run:
        workflows: ['Issue Label Manager']
        types:
            - completed
    workflow_dispatch:
        inputs:
            full_sync:
                description: '执行全量文章同步'
                required: false
                type: boolean
                default: false

# 防止并发执行，避免 git push 冲突
concurrency:
    group: articles-sync
    cancel-in-progress: false # 不取消正在运行的任务，而是排队等待

jobs:
    sync-articles:
        runs-on: ubuntu-latest
        # 如果是 workflow_run 触发，要求上游必须成功
        if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
        permissions:
            contents: write
            issues: read

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Create data directory
              run: mkdir -p public/data

            - name: Check if sync is needed
              id: check_sync
              uses: actions/github-script@v7
              with:
                  script: |
                      const script = require(`${process.env.GITHUB_WORKSPACE}/scripts/check-sync.cjs`);
                      await script({ github, context, core });

            - name: Sync articles
              if: steps.check_sync.outputs.should_sync == 'true'
              uses: actions/github-script@v7
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  script: |
                      const script = require(`${process.env.GITHUB_WORKSPACE}/scripts/sync-articles.cjs`);
                      await script({ github, context, core });

            - name: Commit and push changes
              if: steps.check_sync.outputs.should_sync == 'true'
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  if [ -f public/data/articles.json ]; then
                    git add public/data/articles.json
                  fi

                  if ! git diff --staged --quiet; then
                    git commit -m "chore: 更新文章数据"
                    
                    # 推送时如果失败则拉取并重试
                    for i in {1..3}; do
                      if git push; then
                        echo "✅ 推送成功"
                        break
                      else
                        echo "⚠️  推送失败，尝试拉取最新代码..."
                        git pull --rebase
                        if [ $i -eq 3 ]; then
                          echo "❌ 推送失败，已重试3次"
                          exit 1
                        fi
                      fi
                    done
                  else
                    echo "没有变更需要提交"
                  fi
