name: Sync Articles

on:
    issues:
        types: [edited, unlabeled] # opened 和 labeled 交给 Guard 任务处理后触发
    workflow_run:
        workflows: ['Issue Label Manager']
        types:
            - completed
    workflow_dispatch:

# 防止并发执行，避免 git push 冲突
concurrency:
    group: articles-sync
    cancel-in-progress: false # 不取消正在运行的任务，而是排队等待

jobs:
    sync-articles:
        runs-on: ubuntu-latest
        # 如果是 workflow_run 触发，要求上游必须成功
        if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
        permissions:
            contents: write
            issues: read

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.ref }}

            - name: Create data directory
              run: mkdir -p public/data

            - name: Get issue number from upstream workflow
              id: get_issue
              if: github.event_name == 'workflow_run'
              uses: actions/github-script@v7
              with:
                  script: |
                      // 获取上游 workflow run 的详情
                      const runId = context.payload.workflow_run.id;
                      console.log(`上游 workflow run ID: ${runId}`);
                      
                      // 获取触发上游 workflow 的事件
                      const { data: run } = await github.rest.actions.getWorkflowRun({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          run_id: runId
                      });
                      
                      // 从 head_commit message 或其他方式获取 issue number
                      // 上游是 issues 事件触发的，可以从 run 的 event payload 获取
                      // 但 GitHub API 不直接暴露这个，需要从 artifacts 或其他方式传递
                      
                      // 替代方案：从上游 workflow 的 jobs 日志中解析，或者让上游传递
                      // 最简单的方案：查询最近被修改的 issue
                      const { data: issues } = await github.rest.issues.listForRepo({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          state: 'all',
                          sort: 'updated',
                          direction: 'desc',
                          per_page: 1
                      });
                      
                      if (issues.length > 0) {
                          const issueNumber = issues[0].number;
                          console.log(`最近更新的 Issue: #${issueNumber}`);
                          core.setOutput('issue_number', issueNumber);
                      } else {
                          console.log('没有找到 Issue');
                          core.setOutput('issue_number', '');
                      }

            - name: Check if sync is needed
              id: check_sync
              uses: actions/github-script@v7
              env:
                  UPSTREAM_ISSUE_NUMBER: ${{ steps.get_issue.outputs.issue_number }}
              with:
                  script: |
                      const script = require(`${process.env.GITHUB_WORKSPACE}/scripts/check-sync.cjs`);
                      await script({ github, context, core });

            - name: Sync articles
              if: steps.check_sync.outputs.should_sync == 'true'
              uses: actions/github-script@v7
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  UPSTREAM_ISSUE_NUMBER: ${{ steps.get_issue.outputs.issue_number }}
              with:
                  script: |
                      const script = require(`${process.env.GITHUB_WORKSPACE}/scripts/sync-articles.cjs`);
                      await script({ github, context, core });

            - name: Commit and push changes
              if: steps.check_sync.outputs.should_sync == 'true'
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  if [ -f public/data/articles.json ]; then
                    git add public/data/articles.json
                  fi

                  if ! git diff --staged --quiet; then
                    git commit -m "chore: 更新文章数据"
                    
                    # 推送时如果失败则拉取并重试
                    for i in {1..3}; do
                      if git push; then
                        echo "✅ 推送成功"
                        break
                      else
                        echo "⚠️  推送失败，尝试拉取最新代码..."
                        git pull --rebase
                        if [ $i -eq 3 ]; then
                          echo "❌ 推送失败，已重试3次"
                          exit 1
                        fi
                      fi
                    done
                  else
                    echo "没有变更需要提交"
                  fi
