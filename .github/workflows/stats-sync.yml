name: Stats Sync

on:
    issues:
        types: [labeled, unlabeled]
    workflow_dispatch:
        inputs:
            full_sync:
                description: '执行全量标签统计'
                required: false
                type: boolean
                default: true
    schedule:
        # 每天凌晨 3 点同步标签统计
        - cron: '0 3 * * *'

jobs:
    sync-labels:
        runs-on: ubuntu-latest
        permissions:
            contents: write
            issues: read

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: Create data directory
              run: mkdir -p public/data

            - name: Sync labels and categories
              uses: actions/github-script@v7
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  script: |
                      const fs = require('fs');
                      const path = require('path');

                      const dataDir = path.join(process.cwd(), 'public', 'data');

                      // 辅助函数：解析标签
                      function parseLabels(labels) {
                        const labelNames = labels.map(l => l.name);
                        return {
                          status: labelNames.find(l => l.startsWith('状态:'))?.replace('状态:', ''),
                          categories: labelNames.filter(l => l.startsWith('分类:')).map(l => l.replace('分类:', '')),
                          features: labelNames.filter(l => l.startsWith('功能:')).map(l => l.replace('功能:', '')),
                          tags: labelNames.filter(l => !l.includes(':'))
                        };
                      }

                      // 直接从仓库获取所有标签定义
                      console.log('正在获取仓库所有标签定义...');
                                            
                      const allLabels = await github.paginate(github.rest.issues.listLabelsForRepo, {
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        per_page: 100
                      });
                                            
                      console.log(`找到 ${allLabels.length} 个标签定义`);
                                            
                      // 获取所有已发布的文章（用于统计使用次数）
                      const issues = await github.paginate(github.rest.issues.listForRepo, {
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        state: 'open',
                        labels: '状态:已发布',
                        per_page: 100
                      });
                                            
                      console.log(`找到 ${issues.length} 篇已发布文章`);

                      // 生成标签统计（只包含分类标签，用于标签云显示）
                      const tagsMap = {};

                      // 从所有标签中提取分类标签
                      allLabels.forEach(label => {
                        if (label.name.startsWith('分类:')) {
                          const tagName = label.name.replace('分类:', '');
                          tagsMap[tagName] = 0;
                        }
                      });

                      // 统计每个分类标签的使用次数
                      issues.forEach(issue => {
                        const parsed = parseLabels(issue.labels);
                        parsed.categories.forEach(cat => {
                          if (tagsMap.hasOwnProperty(cat)) {
                            tagsMap[cat]++;
                          }
                        });
                      });

                      const tagsData = {
                        tags: Object.entries(tagsMap).map(([name, count]) => ({ name, count }))
                          .sort((a, b) => b.count - a.count)
                      };
                      fs.writeFileSync(path.join(dataDir, 'tags.json'), JSON.stringify(tagsData, null, 2));
                      console.log(`✅ 已生成标签统计: ${tagsData.tags.length} 个标签`);

            - name: Commit and push changes
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  # 检查文件是否存在并添加
                  if [ -f public/data/tags.json ]; then
                    git add public/data/tags.json
                  fi

                  # 只有在有变更时才提交
                  if ! git diff --staged --quiet; then
                    git commit -m "chore: 更新标签统计 [skip ci]"
                    git push
                  else
                    echo "没有变更需要提交"
                  fi
