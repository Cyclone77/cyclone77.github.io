name: Sync Labels and Categories

on:
    issues:
        types: [labeled, unlabeled]
    workflow_dispatch:
        inputs:
            full_sync:
                description: '执行全量标签统计'
                required: false
                type: boolean
                default: true
    schedule:
        # 每天凌晨 3 点同步标签统计
        - cron: '0 3 * * *'

jobs:
    sync-labels:
        runs-on: ubuntu-latest
        permissions:
            contents: write
            issues: read

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: Create data directory
              run: mkdir -p public/data

            - name: Sync labels and categories
              uses: actions/github-script@v7
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  script: |
                      const fs = require('fs');
                      const path = require('path');

                      const dataDir = path.join(process.cwd(), 'public', 'data');
                      const articlesFile = path.join(dataDir, 'articles.json');

                      // 辅助函数：解析标签
                      function parseLabels(labels) {
                        const labelNames = labels.map(l => l.name);
                        return {
                          status: labelNames.find(l => l.startsWith('状态:'))?.replace('状态:', ''),
                          categories: labelNames.filter(l => l.startsWith('分类:')).map(l => l.replace('分类:', '')),
                          features: labelNames.filter(l => l.startsWith('功能:')).map(l => l.replace('功能:', '')),
                          tags: labelNames.filter(l => !l.includes(':'))
                        };
                      }

                      // 读取现有文章数据
                      let articlesData = { articles: [], total: 0, lastUpdate: new Date().toISOString() };

                      if (fs.existsSync(articlesFile)) {
                        articlesData = JSON.parse(fs.readFileSync(articlesFile, 'utf8'));
                        console.log(`读取到 ${articlesData.articles.length} 篇文章`);
                      } else {
                        console.log('文章数据文件不存在，请先运行 Build and Deploy Blog 工作流');
                        return;
                      }

                      // 生成分类统计
                      const categoriesMap = {};
                      articlesData.articles.forEach(article => {
                        article.categories.forEach(cat => {
                          if (!categoriesMap[cat]) {
                            categoriesMap[cat] = { name: cat, slug: cat, count: 0, color: 'text-primary' };
                          }
                          categoriesMap[cat].count++;
                        });
                      });

                      const categoriesData = {
                        categories: Object.values(categoriesMap)
                      };
                      fs.writeFileSync(path.join(dataDir, 'categories.json'), JSON.stringify(categoriesData, null, 2));
                      console.log(`✅ 已生成分类统计: ${categoriesData.categories.length} 个分类`);

                      // 生成标签统计
                      const tagsMap = {};
                      articlesData.articles.forEach(article => {
                        article.tags.forEach(tag => {
                          tagsMap[tag] = (tagsMap[tag] || 0) + 1;
                        });
                      });

                      const tagsData = {
                        tags: Object.entries(tagsMap).map(([name, count]) => ({ name, count }))
                          .sort((a, b) => b.count - a.count)
                      };
                      fs.writeFileSync(path.join(dataDir, 'tags.json'), JSON.stringify(tagsData, null, 2));
                      console.log(`✅ 已生成标签统计: ${tagsData.tags.length} 个标签`);

            - name: Commit and push changes
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git add public/data/tags.json public/data/categories.json
                  git diff --staged --quiet || git commit -m "chore: 更新标签和分类统计 [skip ci]"
                  git push
