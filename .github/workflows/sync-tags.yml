name: Sync Tags

on:
    workflow_dispatch: # 允许手动触发
    issues:
        types: [unlabeled] # labeled 交给 Guard 任务处理后触发
    workflow_run:
        workflows: ['Issue Label Manager']
        types:
            - completed

# 防止并发执行，避免 git push 冲突
concurrency:
    group: stats-sync
    cancel-in-progress: false # 不取消正在运行的任务，而是排队等待

jobs:
    sync-labels:
        runs-on: ubuntu-latest
        # 如果是 workflow_run 触发，要求上游必须成功
        if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
        permissions:
            contents: write
            issues: read

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: Create data directory
              run: mkdir -p public/data

            - name: Sync labels and categories
              uses: actions/github-script@v7
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  script: |
                      const script = require(`${process.env.GITHUB_WORKSPACE}/scripts/sync-tags.cjs`);
                      await script({ github, context, core });

            - name: Commit and push changes
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  # 检查文件是否存在并添加
                  if [ -f public/data/tags.json ]; then
                    git add public/data/tags.json
                  fi

                  # 只有在有变更时才提交
                  if ! git diff --staged --quiet; then
                    git commit -m "chore: 更新标签统计"
                    
                    # 推送时如果失败则拉取并重试
                    for i in {1..3}; do
                      if git push; then
                        echo "✅ 推送成功"
                        break
                      else
                        echo "⚠️  推送失败，尝试拉取最新代码..."
                        git pull --rebase
                        if [ $i -eq 3 ]; then
                          echo "❌ 推送失败，已重试3次"
                          exit 1
                        fi
                      fi
                    done
                  else
                    echo "没有变更需要提交"
                  fi
