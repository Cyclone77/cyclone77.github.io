name: Blog Deploy

on:
    push:
        branches:
            - master
            - main
    issues:
        types: [opened, edited, labeled, unlabeled] # 增加更多类型以确保同步
    workflow_dispatch:

jobs:
    build-deploy:
        runs-on: ubuntu-latest
        permissions:
            contents: write
            pages: write
            id-token: write
            issues: read

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Check if build is needed
              id: check_build
              if: github.event_name == 'issues'
              uses: actions/github-script@v7
              with:
                  script: |
                      const issueNumber = context.payload.issue?.number;
                      if (!issueNumber) {
                        core.setOutput('should_build', 'true');
                        return;
                      }

                      const issue = await github.rest.issues.get({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: issueNumber
                      });

                      const labels = issue.data.labels.map(l => l.name);
                      const hasPublishedLabel = labels.some(l => l === '状态:已发布');
                      const hadPublishedLabel = context.payload.changes?.labels?.from?.some(l => l.name === '状态:已发布');

                      // 只有当前是已发布，或者之前是已发布（需要删除）时才构建
                      const shouldBuild = hasPublishedLabel || hadPublishedLabel;
                      core.setOutput('should_build', shouldBuild ? 'true' : 'false');
                      console.log(`Issue #${issueNumber} 构建检查: ${shouldBuild ? '需要构建' : '跳过构建（非已发布状态）'}`);

            - name: Restore articles cache
              if: github.event_name != 'issues' || steps.check_build.outputs.should_build == 'true'
              uses: actions/cache@v4
              with:
                  path: public/data
                  key: articles-${{ github.run_id }}
                  restore-keys: |
                      articles-

            - name: Build project
              if: github.event_name != 'issues' || steps.check_build.outputs.should_build == 'true'
              run: npm run build

            - name: Add .nojekyll file
              if: github.event_name != 'issues' || steps.check_build.outputs.should_build == 'true'
              run: touch ./dist/.nojekyll

            - name: Setup Pages
              if: github.event_name != 'issues' || steps.check_build.outputs.should_build == 'true'
              uses: actions/configure-pages@v5

            - name: Upload artifact
              if: github.event_name != 'issues' || steps.check_build.outputs.should_build == 'true'
              uses: actions/upload-pages-artifact@v3
              with:
                  path: ./dist

            - name: Deploy to GitHub Pages
              if: github.event_name != 'issues' || steps.check_build.outputs.should_build == 'true'
              id: deployment
              uses: actions/deploy-pages@v4
