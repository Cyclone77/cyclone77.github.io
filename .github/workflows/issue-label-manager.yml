name: Issue Label Manager

on:
    issues:
        types: [opened, labeled]

jobs:
    auto-label:
        runs-on: ubuntu-latest
        permissions:
            issues: write

        steps:
            - name: Check and add draft label
              if: github.event.action == 'opened'
              uses: actions/github-script@v7
              with:
                  script: |
                      const issue = context.payload.issue;
                      const labels = issue.labels.map(label => label.name);

                      // 检查是否已有状态标签
                      const hasStatusLabel = labels.some(label => label.startsWith('状态:'));

                      if (!hasStatusLabel) {
                        await github.rest.issues.addLabels({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: issue.number,
                          labels: ['状态:草稿']
                        });
                        console.log('已自动添加"状态:草稿"标签');
                      }

            - name: Enforce single status label
              if: github.event.action == 'labeled'
              uses: actions/github-script@v7
              with:
                  script: |
                      const issue = context.payload.issue;
                      const newLabel = context.payload.label.name;

                      // 如果添加的是状态标签
                      if (newLabel.startsWith('状态:')) {
                        const labels = issue.labels.map(label => label.name);
                        
                        // 找出其他状态标签
                        const otherStatusLabels = labels.filter(label => 
                          label.startsWith('状态:') && label !== newLabel
                        );
                        
                        // 移除其他状态标签
                        for (const label of otherStatusLabels) {
                          await github.rest.issues.removeLabel({
                            owner: context.repo.owner,
                            repo: context.repo.repo,
                            issue_number: issue.number,
                            name: label
                          });
                          console.log(`已移除标签: ${label}`);
                        }
                        
                        console.log(`保留唯一状态标签: ${newLabel}`);
                      }
